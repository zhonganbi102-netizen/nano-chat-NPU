# åä¸ºæ˜‡è…¾NPUè¿è¡ŒæŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

#### ç¡¬ä»¶è¦æ±‚
- åä¸ºæ˜‡è…¾NPUå¡ (Ascend 910A/910B/310Pç­‰)
- è‡³å°‘64GBç³»ç»Ÿå†…å­˜ (æ¨è128GB+)
- Ubuntu 18.04/20.04/22.04 LTS

#### è½¯ä»¶è¦æ±‚
- Python 3.8-3.11
- åä¸ºæ˜‡è…¾é©±åŠ¨ + CANN 7.0+
- torch_npu

### 2. ä¸€é”®å®‰è£…å’Œè¿è¡Œ

```bash
# å…‹éš†é¡¹ç›®
git clone <nanochat-repo>
cd nanochat

# é…ç½®NPUç¯å¢ƒ
bash setup_ascend.sh

# æ£€æŸ¥ç¯å¢ƒ
python check_npu.py

# å¼€å§‹è®­ç»ƒï¼
bash speedrun_npu.sh
```

## ğŸ“‹ è¯¦ç»†å®‰è£…æ­¥éª¤

### Step 1: å®‰è£…åä¸ºæ˜‡è…¾é©±åŠ¨

```bash
# 1. æ£€æŸ¥NPUè®¾å¤‡
lspci | grep -i ascend
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡º: 01:00.0 Processing accelerators: Huawei Technologies Co., Ltd. Device xxxx

# 2. ä¸‹è½½é©±åŠ¨ (ä»åä¸ºå®˜ç½‘)
# https://www.hiascend.com/hardware/firmware-drivers
# é€‰æ‹©å¯¹åº”çš„é©±åŠ¨ç‰ˆæœ¬

# 3. å®‰è£…é©±åŠ¨ (ä»¥23.0.RC3ä¸ºä¾‹)
sudo ./Ascend-hdk-910b-npu-driver_23.0.RC3_linux-aarch64.run --full

# 4. éªŒè¯å®‰è£…
npu-smi info
```

### Step 2: å®‰è£…CANN

```bash
# 1. ä¸‹è½½CANNè½¯ä»¶åŒ…
# https://www.hiascend.com/software/cann

# 2. å®‰è£…CANN toolkit
sudo ./Ascend-cann-toolkit_7.0.RC1_linux-aarch64.run --install

# 3. å®‰è£…CANN kernels
sudo ./Ascend-cann-kernels-910b_7.0.RC1_linux.run --install

# 4. è®¾ç½®ç¯å¢ƒå˜é‡
source /usr/local/Ascend/ascend-toolkit/set_env.sh
```

### Step 3: å®‰è£…Pythonç¯å¢ƒ

```bash
# 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv nanochat_npu
source nanochat_npu/bin/activate

# 2. å®‰è£…åŸºç¡€ä¾èµ–
pip install torch>=2.1.0
pip install torch_npu -i https://pypi.org/simple/

# 3. å®‰è£…nanochat
cd nanochat
pip install -e .[npu]
```

## ğŸ”§ ç¯å¢ƒé…ç½®è¯¦è§£

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¿…é¡»çš„ç¯å¢ƒå˜é‡
export ASCEND_HOME=/usr/local/Ascend
export PATH=$ASCEND_HOME/ascend-toolkit/latest/bin:$PATH
export LD_LIBRARY_PATH=$ASCEND_HOME/driver/lib64:$ASCEND_HOME/ascend-toolkit/latest/lib64:$LD_LIBRARY_PATH
export PYTHONPATH=$ASCEND_HOME/ascend-toolkit/latest/python/site-packages:$PYTHONPATH

# NPUç‰¹å®šé…ç½®
export ASCEND_OPP_PATH=$ASCEND_HOME/ascend-toolkit/latest/opp
export TOOLCHAIN_HOME=$ASCEND_HOME/ascend-toolkit/latest/toolkit
export ASCEND_AICPU_PATH=$ASCEND_HOME/ascend-toolkit/latest

# è¿è¡Œæ—¶é…ç½®
export ASCEND_RT_VISIBLE_DEVICES=0,1,2,3,4,5,6,7  # æŒ‡å®šå¯è§NPUè®¾å¤‡
export ASCEND_GLOBAL_LOG_LEVEL=3                   # æ—¥å¿—çº§åˆ«
export ASCEND_SLOG_PRINT_TO_STDOUT=0              # ä¸åœ¨stdoutæ‰“å°æ—¥å¿—
```

### æ€§èƒ½è°ƒä¼˜å‚æ•°

```bash
# å†…å­˜ä¼˜åŒ–
export ASCEND_LAUNCH_BLOCKING=1                    # åŒæ­¥æ‰§è¡Œï¼Œä¾¿äºè°ƒè¯•
export NPU_COLLECT_GE_GRAPH=0                     # ä¸æ”¶é›†è®¡ç®—å›¾
export NPU_FUZZY_COMPILE_BLACKLIST=""             # æ¨¡ç³Šç¼–è¯‘é»‘åå•

# åˆ†å¸ƒå¼è®­ç»ƒ
export HCCL_WHITELIST_DISABLE=1                   # ç¦ç”¨ç™½åå•æ£€æŸ¥
export HCCL_IF_IP=127.0.0.1                       # HCCLæ¥å£IP
```

## ğŸƒâ€â™‚ï¸ è¿è¡Œè®­ç»ƒ

### å•å¡è®­ç»ƒ

```bash
# åŸºç¡€è®­ç»ƒ (depth=8, é€‚åˆå•å¡)
python -m scripts.base_train --depth=8 --device_batch_size=8

# ä¸­é—´è®­ç»ƒ
python -m scripts.mid_train --device_batch_size=8

# ç›‘ç£å¾®è°ƒ
python -m scripts.chat_sft --device_batch_size=4
```

### å¤šå¡è®­ç»ƒ (æ¨è)

```bash
# è®¾ç½®NPUå¡æ•°
export WORLD_SIZE=8

# 8å¡åŸºç¡€è®­ç»ƒ
torchrun --standalone --nproc_per_node=8 -m scripts.base_train -- \
    --depth=12 \
    --device_batch_size=16 \
    --total_batch_size=262144

# 8å¡ä¸­é—´è®­ç»ƒ
torchrun --standalone --nproc_per_node=8 -m scripts.mid_train -- \
    --device_batch_size=16 \
    --total_batch_size=262144

# 8å¡ç›‘ç£å¾®è°ƒ
torchrun --standalone --nproc_per_node=8 -m scripts.chat_sft -- \
    --device_batch_size=8 \
    --target_examples_per_step=32

# 8å¡å¼ºåŒ–å­¦ä¹ 
torchrun --standalone --nproc_per_node=8 -m scripts.chat_rl -- \
    --device_batch_size=4 \
    --examples_per_step=16
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

### NPUä½¿ç”¨ç‡ç›‘æ§

```bash
# å®æ—¶ç›‘æ§
watch -n 1 npu-smi info

# è¯¦ç»†ä¿¡æ¯
npu-smi info -t board -i 0
```

### å†…å­˜ç›‘æ§

```bash
# Pythonè„šæœ¬å†…ç›‘æ§
import torch_npu

# å½“å‰å†…å­˜ä½¿ç”¨
current_memory = torch_npu.npu.memory_allocated() / 1024**3
print(f"å½“å‰NPUå†…å­˜: {current_memory:.2f} GB")

# å³°å€¼å†…å­˜ä½¿ç”¨
max_memory = torch_npu.npu.max_memory_allocated() / 1024**3
print(f"å³°å€¼NPUå†…å­˜: {max_memory:.2f} GB")

# æ¸…ç†å†…å­˜
torch_npu.npu.empty_cache()
```

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### 1. NPUä¸å¯ç”¨

**ç—‡çŠ¶**: `torch_npu.npu.is_available()` è¿”å› `False`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥é©±åŠ¨
npu-smi info

# æ£€æŸ¥è®¾å¤‡æ–‡ä»¶
ls -la /dev/davinci*

# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $ASCEND_HOME
echo $LD_LIBRARY_PATH

# é‡æ–°åŠ è½½ç¯å¢ƒ
source /usr/local/Ascend/ascend-toolkit/set_env.sh
```

### 2. å†…å­˜ä¸è¶³

**ç—‡çŠ¶**: `RuntimeError: NPU out of memory`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å‡å°batch size
--device_batch_size=8  # æ”¹ä¸º4æˆ–æ›´å°

# å¢åŠ æ¢¯åº¦ç´¯ç§¯
--gradient_accumulation_steps=4  # å¢å¤§

# ä½¿ç”¨æ›´å°çš„æ¨¡å‹
--depth=8  # å‡å°æ¨¡å‹æ·±åº¦
```

### 3. åˆ†å¸ƒå¼è®­ç»ƒå¤±è´¥

**ç—‡çŠ¶**: `HCCL initialization failed`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping localhost

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 29500

# é‡æ–°è®¾ç½®ç¯å¢ƒå˜é‡
export MASTER_ADDR=127.0.0.1
export MASTER_PORT=29500
export WORLD_SIZE=8
export RANK=0
```

### 4. æ€§èƒ½æ…¢

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¯ç”¨æ··åˆç²¾åº¦
# ä»£ç ä¸­è‡ªåŠ¨å¯ç”¨ï¼Œç¡®ä¿ä½¿ç”¨bfloat16

# ä¼˜åŒ–æ•°æ®åŠ è½½
--dataloader_num_workers=8  # å¢åŠ 

# ä½¿ç”¨ç¼–è¯‘ä¼˜åŒ–
# ä»£ç ä¸­è‡ªåŠ¨å¯ç”¨torch.compile
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### è®­ç»ƒé€Ÿåº¦å‚è€ƒ (Ascend 910B)

| é˜¶æ®µ | æ¨¡å‹å¤§å° | å•å¡é€Ÿåº¦ | 8å¡é€Ÿåº¦ | å†…å­˜ä½¿ç”¨ |
|------|----------|----------|---------|----------|
| Base Training | d12 | 2,000 tok/s | 15,000 tok/s | 24GB |
| Mid Training | d12 | 1,800 tok/s | 13,000 tok/s | 26GB |
| SFT | d12 | 1,500 tok/s | 11,000 tok/s | 22GB |
| RL | d12 | 800 tok/s | 6,000 tok/s | 28GB |

### æ¨¡å‹è§„æ¨¡å»ºè®®

| NPUé…ç½® | æ¨èæ¨¡å‹æ·±åº¦ | æ‰¹æ¬¡å¤§å° | è®­ç»ƒæ—¶é—´ä¼°è®¡ |
|---------|--------------|----------|--------------|
| 1x 910B | depth=8 | batch=8 | ~8å°æ—¶ |
| 2x 910B | depth=10 | batch=12 | ~5å°æ—¶ |
| 4x 910B | depth=12 | batch=16 | ~3å°æ—¶ |
| 8x 910B | depth=12+ | batch=16+ | ~2å°æ—¶ |

## ğŸ” è°ƒè¯•æŠ€å·§

### å¯ç”¨è¯¦ç»†æ—¥å¿—

```bash
# è®¾ç½®æ—¥å¿—çº§åˆ«
export ASCEND_GLOBAL_LOG_LEVEL=0  # ERROR
export ASCEND_GLOBAL_LOG_LEVEL=1  # WARN  
export ASCEND_GLOBAL_LOG_LEVEL=2  # INFO
export ASCEND_GLOBAL_LOG_LEVEL=3  # DEBUG

# å¯ç”¨æ§åˆ¶å°è¾“å‡º
export ASCEND_SLOG_PRINT_TO_STDOUT=1

# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
tail -f $ASCEND_HOME/log/plog/plog-*.log
```

### æ€§èƒ½åˆ†æ

```bash
# ä½¿ç”¨NPU profiler
export PROFILING_MODE=true
export PROFILING_OPTIONS="task_trace:on,aicpu:on"

# è¿è¡Œè®­ç»ƒ
python -m scripts.base_train --depth=8

# åˆ†æç»“æœ
# ç»“æœä¼šä¿å­˜åœ¨ ./prof_xxx ç›®å½•ä¸­
```

## ğŸš€ ç”Ÿäº§éƒ¨ç½²

### WebæœåŠ¡éƒ¨ç½²

```bash
# å¯åŠ¨NPUæ¨ç†æœåŠ¡
python -m scripts.chat_web --host=0.0.0.0 --port=8000

# æˆ–ä½¿ç”¨gunicorn (æ¨èç”Ÿäº§ç¯å¢ƒ)
pip install gunicorn
gunicorn -w 1 -b 0.0.0.0:8000 -k uvicorn.workers.UvicornWorker scripts.chat_web:app
```

### Dockeréƒ¨ç½²

```dockerfile
# NPU Dockeré•œåƒ (éœ€è¦åä¸ºæä¾›çš„åŸºç¡€é•œåƒ)
FROM ascendhub.huaweicloud.com/public-info/ascend-pytorch:23.0.RC3-ubuntu20.04

WORKDIR /app
COPY . /app

# å®‰è£…ä¾èµ–
RUN pip install -e .[npu]

# ç¯å¢ƒå˜é‡
ENV ASCEND_HOME=/usr/local/Ascend
ENV PATH=$ASCEND_HOME/ascend-toolkit/latest/bin:$PATH

# å¯åŠ¨æœåŠ¡
CMD ["python", "-m", "scripts.chat_web"]
```

### æ‰¹é‡æ¨ç†

```python
# batch_inference.py
import torch
import torch_npu
from nanochat.engine import Engine
from nanochat.checkpoint_manager import load_model

# åŠ è½½æ¨¡å‹
model, tokenizer, _ = load_model("sft", device="npu:0")
engine = Engine(model, tokenizer)

# æ‰¹é‡æ¨ç†
questions = ["ä½ å¥½", "ä»€ä¹ˆæ˜¯AI?", "è§£é‡Šä¸€ä¸‹æ·±åº¦å­¦ä¹ "]
responses = []

for question in questions:
    tokens = tokenizer.encode(question, prepend=tokenizer.get_bos_token_id())
    generated, _ = engine.generate_batch(
        tokens, 
        num_samples=1, 
        max_tokens=256, 
        temperature=0.7
    )
    response = tokenizer.decode(generated[0])
    responses.append(response)
    print(f"Q: {question}")
    print(f"A: {response}\n")
```

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [åä¸ºæ˜‡è…¾å®˜ç½‘](https://www.hiascend.com)
- [CANNå¼€å‘æŒ‡å—](https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/700alpha001/devguide/moddevg/moddevg_000001.html)
- [torch_npuæ–‡æ¡£](https://gitee.com/ascend/pytorch/blob/master/docs/zh/PyTorch%E7%BD%91%E7%BB%9C%E8%BF%81%E7%A7%BB%E6%8C%87%E5%8D%97.md)

### ç¤¾åŒºæ”¯æŒ
- [æ˜‡è…¾å¼€å‘è€…ç¤¾åŒº](https://bbs.huaweicloud.com/forum/forum-726-1.html)
- [GitHub Issues](https://github.com/Ascend/pytorch/issues)
- [ModelArtsè®ºå›](https://bbs.huaweicloud.com/forum/forum-345-1.html)

### æŠ€æœ¯æ”¯æŒ
å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. NPUå‹å·å’Œé©±åŠ¨ç‰ˆæœ¬ (`npu-smi info`)
2. CANNç‰ˆæœ¬ (`cat $ASCEND_HOME/ascend-toolkit/latest/VERSION.info`)
3. torch_npuç‰ˆæœ¬ (`python -c "import torch_npu; print(torch_npu.__version__)"`)
4. å®Œæ•´çš„é”™è¯¯æ—¥å¿—

---

**ğŸ‰ æ­å–œï¼ç°åœ¨ä½ å¯ä»¥åœ¨åä¸ºæ˜‡è…¾NPUä¸Šäº«å—nanochatè®­ç»ƒçš„å¿«æ„Ÿäº†ï¼**
