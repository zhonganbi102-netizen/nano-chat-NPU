# NPUæ•…éšœæ’é™¤æ‰‹å†Œ

## ğŸš¨ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### 1. ç¯å¢ƒç›¸å…³é”™è¯¯

#### é”™è¯¯: `torch_npu not found`
```
ImportError: No module named 'torch_npu'
```

**åŸå› **: torch_npuæœªå®‰è£…æˆ–ç‰ˆæœ¬ä¸å…¼å®¹

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥Pythonç‰ˆæœ¬ (éœ€è¦3.8-3.11)
python --version

# 2. å®‰è£…torch_npu
pip uninstall torch_npu  # å…ˆå¸è½½æ—§ç‰ˆæœ¬
pip install torch_npu -i https://pypi.org/simple/

# 3. éªŒè¯å®‰è£…
python -c "import torch_npu; print(torch_npu.__version__)"
```

#### é”™è¯¯: `NPU device not available`
```
RuntimeError: NPU is not available
```

**åŸå› **: NPUé©±åŠ¨æœªæ­£ç¡®å®‰è£…æˆ–é…ç½®

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥NPUè®¾å¤‡
npu-smi info

# 2. æ£€æŸ¥é©±åŠ¨çŠ¶æ€
lsmod | grep drv_davinci

# 3. é‡æ–°é…ç½®ç¯å¢ƒå˜é‡
export ASCEND_HOME=/usr/local/Ascend
source $ASCEND_HOME/ascend-toolkit/set_env.sh

# 4. é‡å¯NPUé©±åŠ¨
sudo rmmod drv_davinci_mngr
sudo rmmod drv_davinci
sudo modprobe drv_davinci
sudo modprobe drv_davinci_mngr
```

### 2. å†…å­˜ç›¸å…³é”™è¯¯

#### é”™è¯¯: `NPU out of memory`
```
RuntimeError: NPU out of memory. Tried to allocate 2.00 GiB
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ–¹æ¡ˆ1: å‡å°æ‰¹æ¬¡å¤§å°
--device_batch_size=4  # ä»16å‡åˆ°4

# æ–¹æ¡ˆ2: å¢åŠ æ¢¯åº¦ç´¯ç§¯
--gradient_accumulation_steps=8

# æ–¹æ¡ˆ3: ä½¿ç”¨æ›´å°çš„æ¨¡å‹
--depth=8  # ä»12å‡åˆ°8

# æ–¹æ¡ˆ4: æ¸…ç†å†…å­˜ç¼“å­˜
python -c "import torch_npu; torch_npu.npu.empty_cache()"
```

#### é”™è¯¯: `Memory fragmentation`
```
RuntimeError: NPU memory fragmentation
```

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. å®šæœŸæ¸…ç†å†…å­˜
import torch_npu

def cleanup_memory():
    torch_npu.npu.empty_cache()
    torch_npu.npu.synchronize()

# 2. ä½¿ç”¨å†…å­˜æ± 
torch_npu.npu.set_memory_strategy("pool")

# 3. é™åˆ¶å†…å­˜å¢é•¿
torch_npu.npu.set_memory_fraction(0.8)  # ä½¿ç”¨80%å†…å­˜
```

### 3. åˆ†å¸ƒå¼è®­ç»ƒé”™è¯¯

#### é”™è¯¯: `HCCL initialization failed`
```
RuntimeError: HCCL initialization failed
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $MASTER_ADDR  # åº”è¯¥æ˜¯127.0.0.1æˆ–å®é™…IP
echo $MASTER_PORT  # åº”è¯¥æ˜¯29500æˆ–å…¶ä»–å¯ç”¨ç«¯å£
echo $WORLD_SIZE   # åº”è¯¥ç­‰äºNPUå¡æ•°
echo $RANK         # åº”è¯¥ä»0å¼€å§‹

# 2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping $MASTER_ADDR
telnet $MASTER_ADDR $MASTER_PORT

# 3. é‡æ–°è®¾ç½®åˆ†å¸ƒå¼ç¯å¢ƒ
export MASTER_ADDR=127.0.0.1
export MASTER_PORT=29500
export WORLD_SIZE=8
export RANK=0

# 4. ä½¿ç”¨ä¸åŒçš„åç«¯
export HCCL_WHITELIST_DISABLE=1
export HCCL_IF_IP=127.0.0.1
```

#### é”™è¯¯: `Process group timeout`
```
RuntimeError: Timed out initializing process group
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. å¢åŠ è¶…æ—¶æ—¶é—´
export TORCH_DISTRIBUTED_TIMEOUT=1800  # 30åˆ†é’Ÿ

# 2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
sudo ufw status
sudo ufw allow 29500  # å¼€æ”¾ç«¯å£

# 3. ä½¿ç”¨æœ¬åœ°é€šä¿¡
export NCCL_SOCKET_IFNAME=lo  # ä½¿ç”¨æœ¬åœ°å›ç¯
```

### 4. æ¨¡å‹è®­ç»ƒé”™è¯¯

#### é”™è¯¯: `Gradient explosion`
```
RuntimeError: Loss is NaN or Inf
```

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. æ£€æŸ¥å­¦ä¹ ç‡
--learning_rate=1e-5  # é™ä½å­¦ä¹ ç‡

# 2. å¯ç”¨æ¢¯åº¦è£å‰ª
--grad_clip=1.0

# 3. æ£€æŸ¥æ•°æ®è´¨é‡
def check_data_quality(dataloader):
    for batch in dataloader:
        if torch.isnan(batch).any():
            print("å‘ç°NaNæ•°æ®")
        if torch.isinf(batch).any():
            print("å‘ç°Infæ•°æ®")

# 4. ä½¿ç”¨æ¢¯åº¦ç¼©æ”¾
scaler = torch.npu.amp.GradScaler()
```

#### é”™è¯¯: `Compilation failed`
```
RuntimeError: Failed to compile graph
```

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. ç¦ç”¨ç¼–è¯‘ä¼˜åŒ–
# åœ¨ä»£ç ä¸­æ³¨é‡Šæ‰
# model = torch.compile(model)

# 2. ä½¿ç”¨å…¼å®¹æ¨¡å¼
model = torch.compile(model, mode="default")

# 3. æ£€æŸ¥ç®—å­æ”¯æŒ
def check_unsupported_ops():
    # è®°å½•ä¸æ”¯æŒçš„ç®—å­
    torch.npu.set_compile_mode(torch.npu.get_compile_mode().debug)
```

### 5. æ•°æ®åŠ è½½é”™è¯¯

#### é”™è¯¯: `DataLoader stuck`
```
DataLoader worker process hung
```

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. å‡å°‘workeræ•°é‡
num_workers=4  # ä»8å‡åˆ°4

# 2. ç¦ç”¨multiprocessing
num_workers=0

# 3. æ£€æŸ¥å…±äº«å†…å­˜
df -h /dev/shm  # ç¡®ä¿è¶³å¤Ÿå¤§

# 4. ä½¿ç”¨ä¸åŒçš„å¯åŠ¨æ–¹æ³•
import multiprocessing
multiprocessing.set_start_method('spawn', force=True)
```

#### é”™è¯¯: `Tokenizer encoding failed`
```
UnicodeDecodeError: Failed to encode text
```

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. æ£€æŸ¥æ–‡æœ¬ç¼–ç 
def clean_text(text):
    # ç§»é™¤ç‰¹æ®Šå­—ç¬¦
    import re
    text = re.sub(r'[^\x00-\x7F]+', '', text)
    return text

# 2. ä½¿ç”¨é”™è¯¯å¤„ç†
try:
    tokens = tokenizer.encode(text)
except Exception as e:
    print(f"ç¼–ç å¤±è´¥: {e}")
    tokens = tokenizer.encode("[UNK]")
```

## ğŸ”§ è¯Šæ–­å·¥å…·

### 1. ç¯å¢ƒæ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# env_check.sh - ç¯å¢ƒè¯Šæ–­è„šæœ¬

echo "=== NPUç¯å¢ƒè¯Šæ–­ ==="

# æ£€æŸ¥ç¡¬ä»¶
echo "1. ç¡¬ä»¶æ£€æŸ¥"
lspci | grep -i ascend
echo "NPUè®¾å¤‡æ•°é‡: $(ls /dev/davinci* 2>/dev/null | wc -l)"

# æ£€æŸ¥é©±åŠ¨
echo "2. é©±åŠ¨æ£€æŸ¥"
npu-smi info 2>/dev/null || echo "âŒ npu-smiä¸å¯ç”¨"
lsmod | grep drv_davinci || echo "âŒ NPUé©±åŠ¨æœªåŠ è½½"

# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo "3. ç¯å¢ƒå˜é‡æ£€æŸ¥"
echo "ASCEND_HOME: ${ASCEND_HOME:-æœªè®¾ç½®}"
echo "LD_LIBRARY_PATH: ${LD_LIBRARY_PATH:-æœªè®¾ç½®}"
echo "PYTHONPATH: ${PYTHONPATH:-æœªè®¾ç½®}"

# æ£€æŸ¥Pythonç¯å¢ƒ
echo "4. Pythonç¯å¢ƒæ£€æŸ¥"
python -c "
try:
    import torch
    print(f'âœ… PyTorch: {torch.__version__}')
except:
    print('âŒ PyTorchæœªå®‰è£…')

try:
    import torch_npu
    print(f'âœ… torch_npu: {torch_npu.__version__}')
    print(f'âœ… NPUå¯ç”¨: {torch_npu.npu.is_available()}')
    print(f'âœ… NPUæ•°é‡: {torch_npu.npu.device_count()}')
except Exception as e:
    print(f'âŒ torch_npué”™è¯¯: {e}')
"

echo "=== è¯Šæ–­å®Œæˆ ==="
```

### 2. æ€§èƒ½ç›‘æ§è„šæœ¬

```python
#!/usr/bin/env python3
# monitor.py - NPUæ€§èƒ½ç›‘æ§

import time
import subprocess
import json
from datetime import datetime

def get_npu_info():
    """è·å–NPUä¿¡æ¯"""
    try:
        result = subprocess.run(['npu-smi', 'info', '-t', 'board', '-f', 'json'], 
                              capture_output=True, text=True)
        if result.returncode == 0:
            return json.loads(result.stdout)
    except:
        return None

def monitor_npu(duration=60, interval=5):
    """ç›‘æ§NPUæ€§èƒ½"""
    print(f"å¼€å§‹ç›‘æ§NPUæ€§èƒ½ ({duration}ç§’)")
    
    start_time = time.time()
    metrics = []
    
    while time.time() - start_time < duration:
        timestamp = datetime.now().strftime("%H:%M:%S")
        
        # è·å–NPUä¿¡æ¯
        npu_info = get_npu_info()
        if npu_info:
            for board in npu_info.get('board_list', []):
                device_id = board['device_id']
                utilization = board.get('utilization', 'N/A')
                memory_used = board.get('memory_used', 'N/A')
                memory_total = board.get('memory_total', 'N/A')
                temperature = board.get('temperature', 'N/A')
                power = board.get('power', 'N/A')
                
                print(f"[{timestamp}] NPU{device_id}: "
                      f"åˆ©ç”¨ç‡={utilization}%, "
                      f"å†…å­˜={memory_used}/{memory_total}MB, "
                      f"æ¸©åº¦={temperature}Â°C, "
                      f"åŠŸè€—={power}W")
                
                metrics.append({
                    'timestamp': timestamp,
                    'device_id': device_id,
                    'utilization': utilization,
                    'memory_used': memory_used,
                    'temperature': temperature,
                    'power': power
                })
        
        time.sleep(interval)
    
    return metrics

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('--duration', type=int, default=60, help='ç›‘æ§æ—¶é•¿(ç§’)')
    parser.add_argument('--interval', type=int, default=5, help='é‡‡æ ·é—´éš”(ç§’)')
    args = parser.parse_args()
    
    metrics = monitor_npu(args.duration, args.interval)
    print(f"æ”¶é›†äº† {len(metrics)} ä¸ªæ•°æ®ç‚¹")
```

### 3. è‡ªåŠ¨æ•…éšœè¯Šæ–­

```python
#!/usr/bin/env python3
# auto_diagnose.py - è‡ªåŠ¨æ•…éšœè¯Šæ–­

import subprocess
import sys
import os
import torch

def run_command(cmd):
    """æ‰§è¡Œå‘½ä»¤å¹¶è¿”å›ç»“æœ"""
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        return result.returncode == 0, result.stdout, result.stderr
    except:
        return False, "", "å‘½ä»¤æ‰§è¡Œå¤±è´¥"

def diagnose_system():
    """ç³»ç»Ÿè¯Šæ–­"""
    print("ğŸ” å¼€å§‹ç³»ç»Ÿè¯Šæ–­...")
    
    issues = []
    
    # 1. æ£€æŸ¥NPUè®¾å¤‡
    success, stdout, stderr = run_command("lspci | grep -i ascend")
    if not success or not stdout.strip():
        issues.append("âŒ æœªæ£€æµ‹åˆ°Ascend NPUè®¾å¤‡")
    else:
        print("âœ… æ£€æµ‹åˆ°Ascend NPUè®¾å¤‡")
    
    # 2. æ£€æŸ¥é©±åŠ¨
    success, stdout, stderr = run_command("lsmod | grep drv_davinci")
    if not success or not stdout.strip():
        issues.append("âŒ NPUé©±åŠ¨æœªåŠ è½½")
    else:
        print("âœ… NPUé©±åŠ¨å·²åŠ è½½")
    
    # 3. æ£€æŸ¥npu-smi
    success, stdout, stderr = run_command("npu-smi info")
    if not success:
        issues.append("âŒ npu-smiå‘½ä»¤ä¸å¯ç”¨")
    else:
        print("âœ… npu-smiå‘½ä»¤æ­£å¸¸")
    
    # 4. æ£€æŸ¥ç¯å¢ƒå˜é‡
    required_vars = ['ASCEND_HOME', 'LD_LIBRARY_PATH', 'PYTHONPATH']
    for var in required_vars:
        if not os.environ.get(var):
            issues.append(f"âŒ ç¯å¢ƒå˜é‡ {var} æœªè®¾ç½®")
        else:
            print(f"âœ… ç¯å¢ƒå˜é‡ {var} å·²è®¾ç½®")
    
    # 5. æ£€æŸ¥PythonåŒ…
    try:
        import torch_npu
        print(f"âœ… torch_npuç‰ˆæœ¬: {torch_npu.__version__}")
        
        if torch_npu.npu.is_available():
            print(f"âœ… NPUå¯ç”¨ï¼Œè®¾å¤‡æ•°é‡: {torch_npu.npu.device_count()}")
        else:
            issues.append("âŒ NPUä¸å¯ç”¨")
    except ImportError:
        issues.append("âŒ torch_npuæœªå®‰è£…")
    except Exception as e:
        issues.append(f"âŒ torch_npué”™è¯¯: {e}")
    
    # 6. æ£€æŸ¥å†…å­˜
    try:
        import torch_npu
        if torch_npu.npu.is_available():
            device = torch.device('npu:0')
            test_tensor = torch.randn(100, 100, device=device)
            print("âœ… NPUå†…å­˜æµ‹è¯•é€šè¿‡")
    except Exception as e:
        issues.append(f"âŒ NPUå†…å­˜æµ‹è¯•å¤±è´¥: {e}")
    
    return issues

def suggest_solutions(issues):
    """æ ¹æ®é—®é¢˜æä¾›è§£å†³æ–¹æ¡ˆ"""
    if not issues:
        print("ğŸ‰ ç³»ç»Ÿæ£€æŸ¥é€šè¿‡ï¼Œæ²¡æœ‰å‘ç°é—®é¢˜ï¼")
        return
    
    print("\nğŸ”§ å‘ç°ä»¥ä¸‹é—®é¢˜åŠå»ºè®®è§£å†³æ–¹æ¡ˆ:")
    
    solutions = {
        "æœªæ£€æµ‹åˆ°Ascend NPUè®¾å¤‡": [
            "æ£€æŸ¥NPUå¡æ˜¯å¦æ­£ç¡®å®‰è£…",
            "ç¡®è®¤BIOSä¸­å·²å¯ç”¨NPUè®¾å¤‡",
            "æ£€æŸ¥PCIeè¿æ¥"
        ],
        "NPUé©±åŠ¨æœªåŠ è½½": [
            "é‡æ–°å®‰è£…NPUé©±åŠ¨",
            "æ£€æŸ¥é©±åŠ¨ç‰ˆæœ¬å…¼å®¹æ€§",
            "æ‰§è¡Œ: sudo modprobe drv_davinci"
        ],
        "npu-smiå‘½ä»¤ä¸å¯ç”¨": [
            "é‡æ–°å®‰è£…NPUå·¥å…·åŒ…",
            "æ£€æŸ¥PATHç¯å¢ƒå˜é‡",
            "ç¡®è®¤CANNæ­£ç¡®å®‰è£…"
        ],
        "torch_npuæœªå®‰è£…": [
            "æ‰§è¡Œ: pip install torch_npu",
            "æ£€æŸ¥Pythonç‰ˆæœ¬å…¼å®¹æ€§(3.8-3.11)",
            "ç¡®è®¤PyTorchç‰ˆæœ¬å…¼å®¹æ€§"
        ],
        "NPUä¸å¯ç”¨": [
            "æ£€æŸ¥NPUé©±åŠ¨çŠ¶æ€",
            "é‡æ–°é…ç½®ç¯å¢ƒå˜é‡",
            "é‡å¯ç³»ç»Ÿ",
            "æ£€æŸ¥è®¾å¤‡æƒé™: ls -la /dev/davinci*"
        ]
    }
    
    for issue in issues:
        print(f"\nâŒ {issue}")
        # æŸ¥æ‰¾åŒ¹é…çš„è§£å†³æ–¹æ¡ˆ
        for problem, sol_list in solutions.items():
            if problem in issue:
                for i, solution in enumerate(sol_list, 1):
                    print(f"   {i}. {solution}")
                break
        else:
            print("   è¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ")

if __name__ == "__main__":
    print("ğŸ” NPUè‡ªåŠ¨æ•…éšœè¯Šæ–­å·¥å…·")
    print("=" * 50)
    
    issues = diagnose_system()
    suggest_solutions(issues)
    
    print("\n" + "=" * 50)
    print("è¯Šæ–­å®Œæˆï¼")
```

### 4. å¿«é€Ÿä¿®å¤è„šæœ¬

```bash
#!/bin/bash
# quick_fix.sh - å¿«é€Ÿä¿®å¤å¸¸è§é—®é¢˜

echo "ğŸ”§ NPUå¿«é€Ÿä¿®å¤å·¥å…·"

# ä¿®å¤1: é‡æ–°åŠ è½½NPUé©±åŠ¨
fix_driver() {
    echo "æ­£åœ¨é‡æ–°åŠ è½½NPUé©±åŠ¨..."
    sudo rmmod drv_davinci_mngr 2>/dev/null
    sudo rmmod drv_davinci 2>/dev/null
    sleep 2
    sudo modprobe drv_davinci
    sudo modprobe drv_davinci_mngr
    echo "é©±åŠ¨é‡æ–°åŠ è½½å®Œæˆ"
}

# ä¿®å¤2: é‡ç½®ç¯å¢ƒå˜é‡
fix_env() {
    echo "æ­£åœ¨é‡ç½®ç¯å¢ƒå˜é‡..."
    export ASCEND_HOME=/usr/local/Ascend
    export PATH=$ASCEND_HOME/ascend-toolkit/latest/bin:$PATH
    export LD_LIBRARY_PATH=$ASCEND_HOME/driver/lib64:$ASCEND_HOME/ascend-toolkit/latest/lib64:$LD_LIBRARY_PATH
    export PYTHONPATH=$ASCEND_HOME/ascend-toolkit/latest/python/site-packages:$PYTHONPATH
    export ASCEND_OPP_PATH=$ASCEND_HOME/ascend-toolkit/latest/opp
    export TOOLCHAIN_HOME=$ASCEND_HOME/ascend-toolkit/latest/toolkit
    export ASCEND_AICPU_PATH=$ASCEND_HOME/ascend-toolkit/latest
    echo "ç¯å¢ƒå˜é‡é‡ç½®å®Œæˆ"
}

# ä¿®å¤3: æ¸…ç†NPUå†…å­˜
fix_memory() {
    echo "æ­£åœ¨æ¸…ç†NPUå†…å­˜..."
    python3 -c "
try:
    import torch_npu
    torch_npu.npu.empty_cache()
    print('NPUå†…å­˜æ¸…ç†å®Œæˆ')
except:
    print('æ— æ³•æ¸…ç†NPUå†…å­˜ï¼Œè¯·æ£€æŸ¥torch_npuå®‰è£…')
"
}

# ä¿®å¤4: é‡ç½®åˆ†å¸ƒå¼è®¾ç½®
fix_distributed() {
    echo "æ­£åœ¨é‡ç½®åˆ†å¸ƒå¼è®¾ç½®..."
    export MASTER_ADDR=127.0.0.1
    export MASTER_PORT=29500
    export WORLD_SIZE=1
    export RANK=0
    export LOCAL_RANK=0
    echo "åˆ†å¸ƒå¼è®¾ç½®é‡ç½®å®Œæˆ"
}

# ä¸»èœå•
case "$1" in
    "driver")
        fix_driver
        ;;
    "env")
        fix_env
        ;;
    "memory")
        fix_memory
        ;;
    "distributed")
        fix_distributed
        ;;
    "all")
        fix_driver
        fix_env
        fix_memory
        fix_distributed
        ;;
    *)
        echo "ç”¨æ³•: $0 {driver|env|memory|distributed|all}"
        echo ""
        echo "é€‰é¡¹è¯´æ˜:"
        echo "  driver      - é‡æ–°åŠ è½½NPUé©±åŠ¨"
        echo "  env         - é‡ç½®ç¯å¢ƒå˜é‡"
        echo "  memory      - æ¸…ç†NPUå†…å­˜"
        echo "  distributed - é‡ç½®åˆ†å¸ƒå¼è®¾ç½®"
        echo "  all         - æ‰§è¡Œæ‰€æœ‰ä¿®å¤"
        exit 1
        ;;
esac

echo "ä¿®å¤å®Œæˆï¼"
```

ä½¿ç”¨è¿™äº›å·¥å…·å¯ä»¥å¿«é€Ÿè¯Šæ–­å’Œè§£å†³NPUç¯å¢ƒä¸­çš„å¸¸è§é—®é¢˜ã€‚è®°ä½è¦æ ¹æ®å…·ä½“çš„é”™è¯¯ä¿¡æ¯é€‰æ‹©åˆé€‚çš„è§£å†³æ–¹æ¡ˆï¼
